#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# .bashrc_p4
# Stephen Niedzielski
# Copyright 2011 Stephen Niedzielski. Licensed under GPLv3+.

# ------------------------------------------------------------------------------
export P4CONFIG=.p4config

# ------------------------------------------------------------------------------
# P4 Sed Magic
# Helps cope with the wildly differing output of P4. The only reliable way to
# make a nice wrapper would be to use marshal Python objects, but that's too
# involved.

# Escape reserved characters in filenames. There's only a small table of
# characters listed in documentation, so there's some confidence this should
# work pretty consistently.
alias p4se="sed -r 's_%_%25_g;s_@_%40_g;s_\\#_%23_g;s_\\*_%2A_g'"

alias  p4sd="sed -nr 's_^(\.\.\. )?(//.+)#[0-9]+.*_\2_p'"

# HACK: deleted files print at the revision they're deleted at not the deletion
# revision.
alias p4sdv="sed -nr 's_#[0-9]+ - deleted as _#0_; s_^(\.\.\. )?(//.+#[0-9]+).*_\2_p'"

alias p4scl="sed -nr 's_^Change ([0-9]+) on.*_\1_p'"
alias p4sw="sed -r 's_.*#[0-9]+ - (/.+)_\1_'"

# ------------------------------------------------------------------------------
p4_client_root() { p4 info|sed -rn 's_Client root: (.*)_\1_p'; }
p4_client_name() { p4 info|sed -rn 's_Client name: (.*)_\1_p'; }
p4_client_view() { p4 client -o "$@"|sed -rn '1,/^View:$/ d;s%^\t%%p'; }
p4_client_view_lhs() { p4 client -o "$@"|sed -rn '1,/^View:$/ d;s%^\t(.+) //.*%\1%p'; }
p4_logged_in()   { p4 login -s > /dev/null; }
p4_user() { p4 info|sed -rn '1s/^User name: (.*)/\1/p'; }

# Diff two clients but account for name differences.
p4_diff_client()
{
  p4_logged_in || return

  local lhs="$1"
  local rhs="${2:-$(p4_client_name)}"

  # Temp files.
  local lhs_file="$(mktemp)"
  local rhs_file="$(mktemp)"

  p4 client -o "$lhs"|sed -r "s%$lhs%CLIENT%g" >| "$lhs_file"
  p4 client -o "$rhs"|sed -r "s%$rhs%CLIENT%g" >| "$rhs_file"

  diff "$lhs_file" "$rhs_file"
  rm -f "$lhs_file" "$rhs_file"
}

# Reconcile client directories recursively with server. My best reasonable
# attempt to implement something like "git status". Only supply dirs. I believe
# that for the most part this tool properly handles add, edit, delete, and
# integrate cases. No native support in P4 to check if branched files have been
# tampered with? I can't think of a way to get the parent of an unsubmitted
# branch.
# TODO: investigate if p4 revert -an can check if branched files have been
# tampered with.
# TODO: canonicalize output?
p4_status()
{
  p4_logged_in || return

  # TODO: try to handle all dirs in one go.
  for d in "${@:-$(p4_client_root)}"
  do
    # P4 doesn't well understand extra slashes. Assume they aren't part of the
    # filename.
    d="${d%%*(/)}"

    # Dump differing and missing files.
    p4 diff -sl "$d"/...|&

    # HACK: P4 incorrectly reports files opened for delete, even if they're
    # deleted.
    sed -r '/^same /d; s%(.*) - file\(s\) not on client\.$%\1%; s%^missing %%'|
    p4se| # Escape reserved characters in filenames.
    p4 -x- opened 2>&1 > /dev/null|
    sed -r '
      s%diff (.*) - file\(s\) not opened on this client\.$%diff \1%;
      s%(.*) - file\(s\) not opened on this client\.$%miss \1%
    '

    # Dump files opened for integrate, resolved, and subsequently modified.
    p4 diff -sb "$d"/... 2> /dev/null|
    sed -r 's%^%diff %'

    # Check for unopened but added files. Dump all files, links, and empty
    # directories.
    find "$d" \( -type f -o -type l -o -type d -empty \)|
  
    # Escape reserved characters in filenames.
    p4se|
  
    # Suppress have files. Reformat added files from stderr.
    p4 -x- have 2>&1 > /dev/null|
    sed -r 's%(.*) - file\(s\) not on client\.$%\1%'|
  
    # Prune out files opened for add or branch.
    p4 -x- opened 2>&1 > /dev/null|
    sed -r 's%(.*) - file\(s\) not opened on this client\.$%add \1%'

    # HACK: P4 doesn't check files opened for add but that don't exist.
    p4 opened|
    sed -rn 's%(//.*)#[0-9]+ - add .*%\1%p'|
    p4 -x- fstat -T clientFile|
    sed -rn 's%\.\.\. clientFile (.*)%\1%p'|
    xargs -rd\\n ls 2>&1 > /dev/null|
    sed -r 's%^ls: cannot access (.*): No such file or directory%miss \1%'
  done

  : # Can't say much about exit status.
}

# p4_status|p4 -x- have|sed ...|p4 -x- sync -q


# Workaround for maxing maxresults.
p4_sync_client()
{
  local path=
  for dir in "$(p4_client_root)/%%1" /%%2 /%%3 /%%4 /%%5 /%%6 /%%7 /%%8 /%%9
  do
    path+="$dir"
    p4 sync -q "$path$1" &
  done
  p4 sync -q "$path/...$1" &
  # TODO: block and kill.

  #p4_client_view|
  #sed -rn 's_\+?//.* (//.*)_\1_p;'| # Only print included client filespecs.
  #xargs -d\\n -n1 -i p4 sync -q '{}'"$1" # Sync each view one at a time.

  # TODO: iterate over args and build hashmap with client file as key using
  # "p4 sync -n"? Then sync.
  # local dash_args=...
  # shift
  # while read file
  # do
  #   for constraint in "${@:-#head}"
  #   do
  #     p4 sync -n "$dash_args" "$file$constraint"|
  #     ...
  #   done
  # done
}

# TODO: tab completion for clients would be super nice.
# $1 template client
# $2 target client
# $3 dir
p4_init()
{
  [[ $# -eq 3 ]] &&
  [[ -n "$P4CONFIG" ]] &&
  p4_logged_in &&

  # Create client directory and enter it.
  mkdir "$3" &&
  cd "$3" &&

  # Templatize from $1 and output result.
  p4 client -ot "$1" "$2" |

  # Adjust new client options and feed back in.
  sed -r 's_(^Options:\t).*_\1allwrite clobber nocompress locked nomodtime rmdir_
          s_(^SubmitOptions:\t).*_\1submitunchanged_
          s_(^LineEnd:\t).*_\1local_' |
  p4 client -i &&

  # 
  echo "P4CLIENT=$2" > "$P4CONFIG"
}





# TODO: make it take CLs or in gen be mroe versatile.
# TODO: just make it output local files...
p4_zip_opened()
{
  p4_logged_in &&

  local dst="$(readlink -m $1)" &&
  mkdir "$dst" &&

  local root="$(p4_client_root)" &&
  pushd "$root" > /dev/null &&
  {
    p4 opened|
    p4sd|
    p4 -x- fstat -T clientFile|
    sed -nr "s%^\.\.\. clientFile $root/%%p"|
    xargs -d\\n cp --parents -t"$dst"
  popd > /dev/null
  }
  # TODO: zip / tar.
}

# mkdir bundle &&
# cd bundle &&
# p4_zip_opened changes &&
#local dst="$1" &&
#mkdir "$dst" &&
#p4 opened|
#grep -Ev ' - add change|delete'|
#p4sdv|
#while read file
#do
  #local
#  out="$dst/$(p4 fstat -T clientFile "$file"|sed -nr "s%^\.\.\. clientFile $root/%%p")"
#  p4 print -qo "$out" "$file"
#done


# mm showcommands
# p4 changes -ssubmitted ./...@\>1000,1020|tr -cd '[:print:]\n'|sed -r 's_Change ([0-9]+) on.*_\1_g'|p4 -x- describe -s
# p4 grep -ie 'cna[mp]|cdnip' ./...@2012/03/01,now
# p4 changes -i //foo/Cdma....java#11,11
# p4 sync @118760 @={119486,119765,119837} ???
# p4 fstat -c changelist
# p4 help interchanges
# time bash -- <<'EOF'
#  p4 sync -n @xxx|p4sdv|
#  xargs -rd\\n -n1000 -P100 p4 sync -q
#EOF



#time {
#  p4 sync -n @xxx|p4sdv|p4se|
#  xargs -rd\\n -n1000 -P100 p4 sync -q
#}


#p4_sync_wrapper
#{
#  # TODO: is there a nicer way without making a Christmas tree?
#  parallel -i p4 sync -n //"$P4CLIENT"/'{}'"$@" -- \
#    '*' \
#    '*/*' \
#    '*/*/*' \
#    '*/*/*/*' \
#    '*/*/*/*/*' \
#    '*/*/*/*/*/*' \
#    '*/*/*/*/*/*/*' \
#    '*/*/*/*/*/*/*/*' \
#    '*/*/*/*/*/*/*/*/*' \
#    '*/*/*/*/*/*/*/*/*/...'|
#  p4sdv|p4se|
#  xargs -rd\\n -n1000 -P0 p4 sync -q
#}

