#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# .bashrc_p4
# Stephen Niedzielski
# Copyright 2011 Stephen Niedzielski. Licensed under GPLv3+.

# ------------------------------------------------------------------------------
# P4 Sed Magic
# Helps cope with the wildly differing output of P4. The only reliable way to
# make a nice wrapper would be to use marshal Python objects, but that's too
# involved.

# Escape reserved characters in filenames. There's only a small table of
# characters listed in documentation, so there's some confidence this should
# work pretty consistently.
alias p4se="s 's_%_%25_g;s_@_%40_g;s_\\#_%23_g;s_\\*_%2A_g'"

# ------------------------------------------------------------------------------
p4_client_root() { p4 info|s -n 's_Client root: (.*)_\1_p'; }
p4_client_name() { p4 info|s -n 's_Client name: (.*)_\1_p'; }

# Diff two clients but account for name differences.
p4_diff_client()
{
  local client2="${2:-$(p4_client_name)}"
  p4 client -o "$client2"|s "s%$client2%%g" > "$client2.client"
  p4 client -o "$1"|s "s%$1%%g" > "$1.client"

  colordiff "$1.client" "$client2.client"
  rm -f "$1.client" "$client2.client"
}

# Reconcile client directories recursively with server. My best reasonable
# attempt to implement something like "git status".
p4_reconcile()
{
  local client_root="$(p4_client_root)"

  # TODO: try to handle all dirs in one go.
  for d in "${@:-$client_root}"
  do
    # 1: dump differing and missing files. Bin stderr -- handles empty
    # synchronization case.
    p4 diff -sl "$d"/... 2> /dev/null |
    g -v '^same '
  
    # 2: check for unopened but added files.
  
    # Dump all files, links, and empty directories.
    f "$d" \( -type f -o -type l -o -type d -empty \)|
  
    # Escape reserved characters in filenames.
    p4se|
  
    # Suppress have files. Reformat added files from stderr.
    p4 -x- have 2>&1 > /dev/null|
    s 's%(.*) - file\(s\) not on client\.$%\1%'|
  
    # Prune out files opened for add.
    p4 -x- opened 2>&1 > /dev/null|
    s 's%(.*) - file\(s\) not opened on this client\.$%add '"$client_root/"'\1%'
  done

  : # Can't say much about exit status.
}

